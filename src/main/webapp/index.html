<html>
<head>
    <title>FitJournal</title>

    <script type="text/javascript" src="res/js/lib/jquery-1.8.3.js"></script>
    <script type="text/javascript" src="res/js/lib/underscore.js"></script>
    <script type="text/javascript" src="res/js/tmpl.js"></script>

    <style type="text/css">
        .red   { color: red; }
        .green { color: green; }
    </style>
</head>
<body style="font: 12px Verdana">
    <h1>Fit Journal</h1>
    <button onclick="showAddMealDialog()" style="display: block">Add Meal</button>
    <button onclick="showAddWorkoutDialog()" style="display: block">Add Workout</button>
    <div id="dayHolder">
        <div id="dayTmpl" class="tmpl" style="display: none;">
            || _.forEach(days, function(day) { ||
                <div style="display: inline-block; height: 500px; width: 180px; border: 1px solid lightblue;">
                    <h2 style="margin-top: 7px; margin-bottom: 7px;">{{ day.title }}</h2>

                    || _.forEach(day.entries, function(entry) { ||
                        <div style="display: table-row; height: 50px; cursor: pointer;">
                            {{ entry.formattedTime }}
                            <div style="display: table-row;">
                                <span>Name: {{ entry.name }}</span>
                                <span>Energy: <span class="{{ entry.colourCss }}">{{ entry.kj }}</span></span>
                            </div>
                        </div>
                    || }); ||

                    <div>
                        Net KJ: <span class="{{ day.colourCss }}">{{ day.netKj }}</span>
                    </div>
                </div>
            || }); ||
        </div>
        <div id="addEntryDialogTmpl" class="tmpl">
            <div id="addEntryDialog" style="display: none; background-color: burlywood; left: 117px; position: absolute; top: 103px; border-radius: 5px 5px 5px 5px; padding: 0 5px 5px;">
                <h3>Add {{ entryType }}</h3>
                <input type="hidden" id="entryModifier" value="{{ modifier }}" />
                <label for="entryTime">Time:</label>
                <input id="entryTime" type="text" value="{{ date }}" />
                <label for="entryName">Name:</label>
                <input id="entryName" type="text" />
                <label for="entryKj">Kj:</label>
                <input id="entryKj" type="text" />
                <button onclick="addEntry()">Add</button>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        function showAddMealDialog()
        {
            var props = {entryType: 'Meal', modifier: '', date: formatDate(new Date())};
            showAddEntryDialog(props);
        }

        function showAddWorkoutDialog()
        {
            var props = {entryType: 'Workout', modifier: '-', date: formatDate(new Date())};
            showAddEntryDialog(props);
        }

        function showAddEntryDialog(props)
        {
            var addEntryTmpl = tmpl.find('addEntryDialogTmpl');
            document.getElementsByTagName('body')[0].innerHTML += _.template(addEntryTmpl, props);
            addEntryDialog.style.display = 'inline-block';
        }

        function addEntry()
        {
            var type = 'POST';
            var url = '/journal';
            var data = { name: entryName.value, kj: entryModifier.value + entryKj.value, entryTime: entryTime.value};

            $.ajax({type: type, url: url, data: data, success: function() { location.reload(); }});

            addEntryDialog.style.display = 'none';
        }

        function getDays()
        {
            $.ajax({url: '/journal', success: function(days){
                addAdditionalProps(days);

                var dayTmpl = tmpl.find('dayTmpl');
                dayHolder.innerHTML += _.template(dayTmpl, {days: days});
            }});
        }

        function addAdditionalProps(days)
        {
            _.forEach(days, function(day) {
                _.forEach(day.entries, function(entry) {
                    entry.colourCss = entry.kj > 0 ? 'red' : 'green';
                });

                day.colourCss = day.netKj > 0 ? 'red' : 'green';
            });
        }

        function formatDate(date)
        {
            return date.getFullYear() + '-' + (date.getMonth() + 1) + '-' + (date.getDay() + 1) + ' 00:00:00';
        }
    </script>

    <script type="text/javascript">
        _.templateSettings = {
            interpolate: /\{\{(.+?)\}\}/g,
            evaluate: /\|\|(.+?)\|\|/g
        };

        tmpl.scrape();

        getDays();
    </script>
</body>
</html>