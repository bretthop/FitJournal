<html>
<head>
    <title>FitJournal</title>

    <script type="text/javascript" src="res/js/lib/jquery-1.8.3.js"></script>
    <script type="text/javascript" src="res/js/lib/underscore.js"></script>
    <script type="text/javascript" src="res/js/tmpl.js"></script>

    <link media="all" rel="stylesheet" type="text/css" href="res/css/fitJournal.css" />
</head>
<body>
    <h1>Fit Journal</h1>
    <button onclick="showAddMealDialog()" class="iblock">Add Meal</button>
    <button onclick="showAddWorkoutDialog()" class="iblock">Add Workout</button>
    <!-- TODO: Make these values dynamic (make them for the current week) -->
    <label for="startDate">Start Date:</label>
    <input type="text" id="startDate" value="2013-09-16 00:00:00"/>
    <label for="endDate">End Date:</label>
    <input type="text" id="endDate" value="2013-09-22 23:59:59"/>
    <button onclick="document.location.reload()">Reload</button>
    <div class="totalEnergyHolder">
        This week net energy: <span class="currentPeriodTotalEnergy">-</span>
        Total net energy: <span class="totalEnergy">-</span>
    </div>
    <div id="daysContainer">
        <div id="dayTmpl" class="tmpl">
            || _.forEach(days, function(day) { ||
                <div class="iblock fleft dayHolder">
                    <h2>{{ day.title }}</h2>

                    || _.forEach(day.entries, function(entry) { ||
                        <div class="iblock entryHolder" onclick="editEntry('{{entry.id}}')">
                            {{ entry.formattedTime }}
                            <div class="iblock">
                                <span>Name: {{ entry.name }}</span>
                                <span>Energy: <span class="{{ entry.colourCss }}">{{ entry.kj }}</span></span>
                            </div>
                        </div>
                    || }); ||

                    <div class="dayTotal">
                        Net KJ: <span class="{{ day.colourCss }}">{{ day.netKj }}</span>
                    </div>
                </div>
            || }); ||
            <div class="cboth"></div>
        </div>
        <div id="addEntryDialogTmpl" class="tmpl">
            <div id="addEntryDialog" class="hidden">
                <h3>Add {{ entry.type.toLowerCase()  }}</h3>
                <input type="hidden" id="entryId" value="{{ entry.id }}" />
                <input type="hidden" id="entryType" value="{{ entry.type }}" />
                <input type="hidden" id="entryModifier" value="{{ entry.modifier }}" />
                <label for="entryTime">Time:</label>
                <input id="entryTime" type="text" value="{{ entry.entryTime }}" />
                <label for="entryName">Name:</label>
                <input id="entryName" type="text" value="{{ entry.name }}" />
                <label for="entryKj">Kj:</label>
                <input id="entryKj" type="text" value="{{ entry.kj }}" />
                <button onclick="hideEntryDialog()">Cancel</button>
                <button onclick="addEntry()">{{ mode }}</button>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        function editEntry(id)
        {
            $.ajax({url: '/journalEntry', data: {id: id}, success: function(entry){
                showAddEntryDialog(entry, 'Update');
            }});
        }

        function showAddMealDialog()
        {
            var entry = { type: 'MEAL', modifier: '',  entryTime: formatDate(new Date()) };
            showAddEntryDialog(entry, 'Add');
        }

        function showAddWorkoutDialog()
        {
            var entry = { type: 'WORKOUT', modifier: '-',  entryTime: formatDate(new Date()) };
            showAddEntryDialog(entry, 'Add');
        }

        function showAddEntryDialog(entry, mode)
        {
            var addEntryTmpl = tmpl.find('addEntryDialogTmpl');
            document.getElementsByTagName('body')[0].innerHTML += _.template(addEntryTmpl, { entry: entry, mode: mode });

            $('#addEntryDialog').show();
        }

        function addEntry()
        {
            var type = 'POST';
            var url = '/journal';
            var data = { id: entryId.value, type: entryType.value, name: entryName.value, kj: entryModifier.value + entryKj.value, entryTime: entryTime.value};

            $.ajax({type: type, url: url, data: data, success: function() { location.reload(); }});

            hideEntryDialog();
        }

        function hideEntryDialog()
        {
            $('#addEntryDialog').remove();
        }

        function getJournalPeriod()
        {
            var data = {
                startDate: document.getElementById('startDate').value,
                endDate: document.getElementById('endDate').value
            };

            $.ajax({url: '/journal', data: data, success: function(period){
                addAdditionalProps(period);

                var dayTmpl = tmpl.find('dayTmpl');
                daysContainer.innerHTML += _.template(dayTmpl, {days: period.days});

                $('.currentPeriodTotalEnergy').html(period.netKj).addClass(period.colourCss);
            }});
        }

        // At the moment this is only being used to get the total energy for the full period
        // This can be optimised
        function getFullJournalPeriod()
        {
            $.ajax({url: '/journal', success: function(period){
                addAdditionalProps(period);

                $('.totalEnergy').html(period.netKj).addClass(period.colourCss);
            }});
        }

        function addAdditionalProps(period)
        {
            _.forEach(period.days, function(day) {
                _.forEach(day.entries, function(entry) {
                    entry.colourCss = entry.kj > 0 ? 'red' : 'green';
                });

                day.colourCss = day.netKj > 0 ? 'red' : 'green';
            });

            period.colourCss = period.netKj > 0 ? 'red' : 'green';
        }

        function formatDate(date)
        {
            return date.getFullYear() + '-' + (date.getMonth() + 1) + '-' + date.getDate() + ' 00:00:00';
        }
    </script>

    <script type="text/javascript">
        _.templateSettings = {
            interpolate: /\{\{(.+?)\}\}/g,
            evaluate: /\|\|(.+?)\|\|/g
        };

        tmpl.scrape();

        getJournalPeriod();
        getFullJournalPeriod();
    </script>
</body>
</html>